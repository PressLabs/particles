workspace:
  base: /drone
  path: src/${DRONE_REPO_NAME}

clone:
  default:
    image: plugins/git
    recursive: true
    group: clone

pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - ./node_modules
      - ./.yarn-cache
    volumes:
      - /tmp/cache:/cache

  build:
    image: presslabs/particles-build
    pull: true
    commands:
      - Xvfb :1 -screen 0 800x600x16 &
      - make build

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - ./node_modules
      - ./.yarn-cache
    volumes:
      - /tmp/cache:/cache

  npm:
    image: plugins/npm
    email: support@presslabs.com
    secrets: [ npm_username, npm_password ]
    when:
      branch: master
      event: push
